[MATLAB](http://www.mathworks.com/products/matlab/) is a programming language and environment which is widely used in many academic and technical fields. This blog post will cover the basics of running MATLAB code using Dexy. If you aren't familiar with Dexy, then the [Getting Started](http://www.dexy.it/docs/getting-started.html) tutorial may help clarify some of the examples in this blog post.

<!-- more -->

Here are a few fun MATLAB examples to get us started.

Here's some code which generates a 3d plot:

{{ d['sections.m|idio|matlabint|pyg']['3d-plot'] }}

And here's the resulting plot:

![Mesh Plot]({{ d['mesh.png|botoup'] }})

MATLAB allows creating anonymous functions:

{{ d['sections.m|idio|matlabint|pyg']['anon-functions'] }}

Here, we use this anonymous function to create another 3D plot:

{{ d['sections.m|idio|matlabint|pyg']['meshgrid-using-anon-fn'] }}

![Mesh Plot]({{ d['mesh-with-function.png|botoup'] }})

Here's an example of solving an ODE representing a [Van der Pol oscillator](http://en.wikipedia.org/wiki/Van_der_Pol_oscillator).

First, we define the dynamical system:

{{ d['sections.m|idio|matlabint|pyg']['van-der-pol-def'] }}

Next, we solve it:
{{ d['sections.m|idio|matlabint|pyg']['van-der-pol-solve'] }}

Finally we graph it:
{{ d['sections.m|idio|matlabint|pyg']['van-der-pol-plot'] }}

![Van der Pol solution]({{ d['van-der-pol.png|botoup'] }})

The same system can also be modelled visually using [Simulink (R)](http://www.mathworks.com/products/simulink/):

{{ d['sections.m|idio|matlabint|pyg']['van-der-pol-simulink'] }}

This is the standard [Van der Pol simulation](http://www.mathworks.com/help/rtwin/examples/real-time-van-der-pol-simulation.html) ('vdp') included in MATLAB distributions:

![Van der Pol solution]({{ d['van-der-pol-simulink.png|botoup'] }})

The `-s` argument to print also allows us to render the visual model:

{{ d['sections.m|idio|matlabint|pyg']['print-simulink-model'] }}

![Van der Pol solution]({{ d['van-der-pol-simulink-model.png|botoup'] }})

{{ d['sections.m|idio|matlabint|pyg']['close'] }}

## Running MATLAB Code in Dexy

Now that we've seen some examples, we'll look in more detail at how we can use
Dexy to run MATLAB code and display the results.

Here's a short MATLAB script showing two ways to solve `A*x=b`:

{{ d['basic.m|pyg'] }}

To evaluate this script in the MATLAB interpreter, apply the `matlabint` filter. The configuration in the `dexy.yaml` is:

{{ d['dexy.yaml|idio']['basic-example'] }}

Here's what the output will look like:

<pre>
{{ d['basic.m|matlabint'] | e }} 
</pre>

The `matlabint` filter launches the matlab interpreter and sends commands, one line at a time. It returns a full session transcript including input prompts, commands and output. You can end a line with `;` to prevent its output from being echoed (this is a feature of the MATLAB interpreter).

## Sections and Syntax Highlighting

The syntax highlighting in this blog post is applied using the `pyg` filter.  The `.m` file extension used by matlab does not uniquely identify code as matlab code within the Pygments syntax highlighter, so we need to specify the lexer manually. Here's how:

{{ d['dexy.yaml|idio']['syntax-highlighting'] }}

Now here's the script we used to generate all the examples in the first section, with syntax highlighting applied:

{{ d['sections.m|pyg'] }}

This script is divided into named sections using specially formatted comments. The `idio` filter knows how to split this script up. We'll apply this filter before we execute the code, so we can capture each section's output separately (this concept is covered in the [Getting Started](http://www.dexy.it/docs/getting-started.html) dexy tutorial mentioned above).

Here's the dexy configuration applied to this file:

{{ d['dexy.yaml|idio']['run-examples'] }}

The `idio` filter splits code into sections, then the `matlabint` filter runs each section through the matlab interpreter, and finally the `pyg` filter applies syntax highlighting to the output.

We also specify some custom configuration for the `matlabint` filter:

{{ d['dexy.yaml|idio']['run-examples-config-matlabint'] }}

The `add-new-files` setting tells dexy to pick up any generated files and add them to the dexy run so other documents can make use of them, and the `additional-doc-filters` setting tells dexy to apply the `botoup` filter to any new files found which use the `.png` extension. This means that any `.png` files generated by the script will be uploaded to S3.

And we specify a custom lexer for the `pyg` filter, this time the `matlabsession` lexer because we are applying syntax highlighting to the output from the matlab interpreter, rather than a matlab `.m` file:

{{ d['dexy.yaml|idio']['run-examples-config-pyg'] }}

We also need to specify some other files as dependencies so they will be
available on the local file system when we run the matlab script:

{{ d['dexy.yaml|idio']['run-examples-dependencies'] }}

Here's the full configuration:

{{ d['dexy.yaml|idio']['run-examples'] }}
{{ d['dexy.yaml|idio']['run-examples-config-matlabint'] }}
{{ d['dexy.yaml|idio']['run-examples-config-pyg'] }}
{{ d['dexy.yaml|idio']['run-examples-dependencies'] }}

Here is how we then include one section of the processed script output in a document using a jinja2 template:

{{ d['index.md|idio']['generate-plot'] }}

It looks like this when rendered:

<!-- section "generate-plot" -->
{{ d['sections.m|idio|matlabint|pyg']['3d-plot'] }}
<!-- section "end" -->

We applied the `botoup` filter to any `.png` files which were generated by our script, and this filter uploads files to S3 and then returns their URL:

{{ d['index.md|idio']['plot-link'] }}

Here is the URL of the generated plot:
<!-- section "plot-link" -->
{{ d['mesh.png|botoup'] }}
<!-- section "end" -->

We can then use this URL to generate an image tag using Markdown syntax:

{{ d['index.md|idio']['show-plot-markdown'] }}

<!-- section "show-plot-markdown" -->
![Mesh Plot]({{ d['mesh.png|botoup'] }})
<!-- section "end" -->

Or do the same thing using raw HTML:

{{ d['index.md|idio']['show-plot-html'] }}

<!-- section "show-plot-html" -->
<img title="Mesh Plot" src="{{ d['mesh.png|botoup'] }}" />
<!-- section "end" -->

## Referencing Individual Values

Sometimes you want to embed calculated values within the text of a document, either instead of or in addition to showing the code which calculated them. One recommended way to do this in Dexy is by writing the data to a JSON file. Here's one way to do this in MATLAB using JSON functions provided by the [jsonlab library](http://iso2mesh.sourceforge.net/cgi-bin/index.cgi?jsonlab):

{{ d['sections.m|idio|matlabint|pyg']['write-js'] }}

The `values.json` file created in this script is detected by the dexy run because we have set `add-new-files` to true. Here's the contents of the generated file:

<pre>
{{ d['values.json'] }}
</pre>

If you reference this file from a document template and try to access the elements within it, Dexy will automatically parse this JSON file into a data structure for you, and thanks to [jinja2's dot syntax](http://jinja.pocoo.org/docs/templates/#variables), you can refer to elements in a JSON object using either dots (as if the values were attributes) or the more usual python dict accessors:

{{ d['index.md|idio']['use-values'] }}

Here's how it looks when this document template is evaluated and the values calculated in the script are embedded within the generated document:

<!-- section "use-values" -->

{% set vars = d["values.json"]["vars"] %}
Foo is {{ vars.foo }} and bar is {{ vars["bar"] }}. Pi is {{ vars.pi }}.

<!-- section "end" -->

## Dexy or MATLAB Publish?

Finally, let's compare using Dexy to using MATLAB's built-in [Publish](http://www.mathworks.com/help/matlab/matlab_prog/publishing-matlab-code.html) feature. Both options let you create documents incorporating MATLAB code and the output from running it, but there are many important differences.

Dexy is a more flexible, general-purpose tool that lets you write many different kinds of documents, both in terms of document format and in terms of the content and intent of a document. With Dexy you can write a report showing just the values resulting from a calculation and generated graphs, like this:

Foo is {{ vars.foo }} and bar is {{ vars["bar"] }}. Pi is {{ vars.pi }}.

![Mesh Plot]({{ d['mesh.png|botoup'] }})

Or you can write some documentation which includes a section of unprocessed source code:

{{ d['sections.m|idio']['anon-functions'] }}

Or you can show the results of running that source code:

{{ d['sections.m|idio|matlabint|pyg']['anon-functions'] }}

With Dexy you can mix and match source code from many different MATLAB files and even include and execute code in other languages.

MATLAB's Publish feature is much more limited, but it has the advantage of being simpler and not requiring you to install any additional software if you already have MATLAB installed.

Here's an example of some MATLAB source code with comments written for the Publish command:

{{ d['example.m|pyg'] }}

Here's what HTML generated via the Publish command looks like:

<iframe src="{{ d['html/example.html|botoup']}}" width="100%" height="300px" >
Foo is {{ vars.foo }} and bar is {{ vars["bar"] }}. Pi is {{ vars.pi }}.
</iframe>

The Publish feature is a great way to generate a presentable record of an interactive session of work, or to document a single script and show its full execution. You have a choice of several document formats and settings to control the output.

{{ d['sections.m|idio|matlabint|pyg']['help'] }}

In comparison, Dexy is a more flexible and powerful tool, but it's harder to learn and requires Python to be installed. Dexy gives you not only a powerful tool for writing documents incorporating code and results, but also a way of automating many other aspects of your project. If you have a complex workflow, Dexy can run all your scripts in the correct order, help you to share data files between them, and finally help you to communicate your results with confidence in their reproducibility.

If you have questions about using Dexy with MATLAB, please feel free to leave a comment or get in touch via one of the suggested methods [here](http://dexy.it/docs/).
